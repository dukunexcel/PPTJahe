<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Keuangan Real-Time</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .money { font-family: 'Courier New', monospace; font-weight: bold; }
        .bg-gradient-header {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-gradient-header text-white p-6 shadow-lg mb-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold tracking-tight">Laporan Kinerja Keuangan</h1>
            <p class="text-indigo-100 mt-1 text-sm">Data Real-Time dari AppSheet | Periode Bulan Ini</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 pb-12">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Total Penjualan Kotor</p>
                <h2 class="text-2xl mt-1 money text-gray-800" id="ui-penjualan-kotor">Rp 0</h2>
                <div class="text-xs text-red-500 mt-2">Retur: <span id="ui-retur">Rp 0</span></div>
            </div>
            
            <div class="card border-l-4 border-green-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Laba Bersih (Net Profit)</p>
                <h2 class="text-3xl mt-1 money text-green-600" id="ui-laba-bersih">Rp 0</h2>
                <div class="text-xs text-gray-400 mt-2">Setelah dikurangi Prive</div>
            </div>

            <div class="card border-l-4 border-indigo-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Arus Kas Bersih</p>
                <h2 class="text-2xl mt-1 money text-indigo-600" id="ui-arus-kas">Rp 0</h2>
                <div class="text-xs text-gray-400 mt-2">Uang tunai tersedia</div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card bg-red-50 text-center">
                <p class="text-xs text-red-600 font-bold uppercase">Hutang Usaha</p>
                <p class="text-lg font-bold text-red-700 money" id="ui-hutang">Rp 0</p>
            </div>
            <div class="card bg-green-50 text-center">
                <p class="text-xs text-green-600 font-bold uppercase">Piutang Usaha</p>
                <p class="text-lg font-bold text-green-700 money" id="ui-piutang">Rp 0</p>
            </div>
            <div class="card bg-yellow-50 text-center col-span-2">
                <p class="text-xs text-yellow-700 font-bold uppercase">Prive (Ambilan Pribadi)</p>
                <p class="text-xl font-bold text-yellow-800 money" id="ui-prive">Rp 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="card">
                    <h3 class="font-bold text-lg mb-4 text-indigo-800">Analisa Profitabilitas Produk</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Kategori</th>
                                    <th class="px-4 py-3 text-right">Omset</th>
                                    <th class="px-4 py-3 text-right">HPP</th>
                                    <th class="px-4 py-3 text-right">Laba</th>
                                    <th class="px-4 py-3 text-center">Margin</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-produk-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-lg mb-4 text-green-800">Analisa Kanal Penjualan (Online/Offline)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Kanal</th>
                                    <th class="px-4 py-3 text-right">Omset</th>
                                    <th class="px-4 py-3 text-right">Laba</th>
                                    <th class="px-4 py-3 text-center">Margin %</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-kanal-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                <div class="card">
                    <h3 class="font-bold text-gray-700 mb-2 text-center">Rincian Beban Operasional</h3>
                    <p class="text-center text-xs text-gray-400 mb-4">Dalam Rupiah</p>
                    <div class="relative h-64">
                        <canvas id="chartBeban"></canvas>
                    </div>
                    <div class="mt-4">
                        <ul id="list-beban" class="text-xs space-y-2 text-gray-600">
                            </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. FUNGSI UTILITAS ---
        
        // Format Rupiah
        const formatRp = (angka) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        };

        // Ambil Parameter URL
        function getParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            // Hapus karakter non-angka jika ada, lalu parse
            const val = urlParams.get(name);
            return val ? parseFloat(val) : 0;
        }

        // Ambil JSON dari URL
        function getJsonParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            const raw = urlParams.get(name);
            try {
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                console.warn("JSON Error atau Kosong:", e);
                return [];
            }
        }

        // --- 2. AMBIL DATA DARI APPSHEET ---
        const DATA = {
            // Header Keuangan
            penjualanKotor: getParam('penjualan_kotor'),
            retur: getParam('total_retur'),
            hppTotal: getParam('hpp_total'),
            bebanOps: getParam('ops_non_prive'),
            prive: getParam('prive_diberikan'),
            labaBersihApp: getParam('laba_bersih'), // Dari rumus AppSheet
            arusKas: getParam('arus_kas_bersih'),
            
            // Neraca
            piutang: getParam('total_piutang'),
            hutang: getParam('total_hutang'),

            // Analisa Produk
            omsetBpom: getParam('omset_bpom'),
            hppBpom: getParam('hpp_bpom'),
            labaBpom: getParam('laba_bpom'),

            omsetNonBpom: getParam('omset_non_bpom'),
            hppNonBpom: getParam('hpp_non_bpom'),
            labaNonBpom: getParam('laba_non_bpom'),

            // Analisa Kanal (Offline/Online)
            hppOffline: getParam('hpp_offline'),
            labaOffline: getParam('laba_offline'),
            hppOnline: getParam('hpp_online'),
            labaOnline: getParam('laba_online'),

            // Rincian Beban (JSON)
            rincianBeban: getJsonParam('beban_rincian')
        };

        // Hitung Omset Kanal (karena AppSheet kirim HPP & Laba)
        const omsetOffline = DATA.hppOffline + DATA.labaOffline;
        const omsetOnline = DATA.hppOnline + DATA.labaOnline;

        // --- 3. RENDER KE TAMPILAN (DOM) ---

        // A. Kartu Atas
        document.getElementById('ui-penjualan-kotor').innerText = formatRp(DATA.penjualanKotor);
        document.getElementById('ui-retur').innerText = formatRp(DATA.retur);
        document.getElementById('ui-laba-bersih').innerText = formatRp(DATA.labaBersihApp);
        document.getElementById('ui-arus-kas').innerText = formatRp(DATA.arusKas);
        
        document.getElementById('ui-hutang').innerText = formatRp(DATA.hutang);
        document.getElementById('ui-piutang').innerText = formatRp(DATA.piutang);
        document.getElementById('ui-prive').innerText = formatRp(DATA.prive);

        // B. Tabel Produk (BPOM vs Non-BPOM)
        const hitungMargin = (laba, omset) => omset === 0 ? 0 : ((laba / omset) * 100).toFixed(1);
        
        const rowProduk = (label, omset, hpp, laba, colorClass) => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3 font-medium ${colorClass}">${label}</td>
                <td class="px-4 py-3 text-right">${formatRp(omset)}</td>
                <td class="px-4 py-3 text-right text-gray-500">${formatRp(hpp)}</td>
                <td class="px-4 py-3 text-right font-bold ${colorClass}">${formatRp(laba)}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-bold ${colorClass === 'text-indigo-600' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100'}">
                        ${hitungMargin(laba, omset)}%
                    </span>
                </td>
            </tr>
        `;

        document.getElementById('tabel-produk-body').innerHTML = `
            ${rowProduk('Produk BPOM', DATA.omsetBpom, DATA.hppBpom, DATA.labaBpom, 'text-indigo-600')}
            ${rowProduk('Non-BPOM', DATA.omsetNonBpom, DATA.hppNonBpom, DATA.labaNonBpom, 'text-gray-600')}
        `;

        // C. Tabel Kanal (Online vs Offline)
        const rowKanal = (label, omset, laba, colorClass) => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3 font-medium ${colorClass}">${label}</td>
                <td class="px-4 py-3 text-right">${formatRp(omset)}</td>
                <td class="px-4 py-3 text-right font-bold ${colorClass}">${formatRp(laba)}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800">
                        ${hitungMargin(laba, omset)}%
                    </span>
                </td>
            </tr>
        `;

        document.getElementById('tabel-kanal-body').innerHTML = `
            ${rowKanal('Offline (Toko)', omsetOffline, DATA.labaOffline, 'text-green-700')}
            ${rowKanal('Online', omsetOnline, DATA.labaOnline, 'text-blue-600')}
        `;

        // --- 4. RENDER GRAFIK (Chart.js) ---

        // Siapkan Data Beban
        let labelBeban = [];
        let dataBeban = [];
        let listHTML = "";

        if (DATA.rincianBeban.length > 0) {
            // Sort beban dari terbesar
            const sortedBeban = DATA.rincianBeban.sort((a, b) => b.nominal - a.nominal);
            
            labelBeban = sortedBeban.map(item => item.nama);
            dataBeban = sortedBeban.map(item => item.nominal);

            // Buat List Text di bawah grafik
            sortedBeban.forEach(item => {
                listHTML += `<li class="flex justify-between border-b border-dashed pb-1">
                    <span>${item.nama}</span>
                    <span class="font-mono font-bold">${formatRp(item.nominal)}</span>
                </li>`;
            });
        } else {
            labelBeban = ["Tidak Ada Data"];
            dataBeban = [1]; // Dummy agar grafik muncul
            listHTML = "<li class='text-center italic'>Data rincian beban belum tersedia</li>";
        }
        
        document.getElementById('list-beban').innerHTML = listHTML;

        // Render Donut Chart
        const ctx = document.getElementById('chartBeban').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labelBeban,
                datasets: [{
                    data: dataBeban,
                    backgroundColor: [
                        '#4f46e5', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false } // Legend disembunyikan agar bersih
                },
                cutout: '70%'
            }
        });

    </script>
</body>
</html>
