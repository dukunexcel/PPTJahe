<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Styling Dasar dan Font Inter */
    body { font-family: 'Inter', sans-serif; }
    
    /* 1. BACKGROUND UTAMA: GRADASI MEMUKAU (Forest Green -> Black -> Neon Green) */
    #app { 
        min-height: 100vh;
        background-color: #000000;
        /* Linear Gradient Diagonal (135deg):
           - 0%: Forest Green (#114e2c) - Nuansa dalam di kiri atas
           - 40-60%: Hitam (#000000) - Area tengah gelap agar kartu konten terlihat jelas
           - 100%: Neon Green (#9bca1a) - Aksen menyala di kanan bawah
        */
        background-image: linear-gradient(135deg, #114e2c 0%, #022c22 30%, #000000 60%, #9bca1a 100%);
        background-attachment: fixed; /* Membuat background tetap statis saat scroll */
        color: #e2e8f0;
    }

    /* Efek Ambient Glow Halus di Tengah */
    #app::before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(17, 78, 44, 0.15) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
    }

    /* 2. CARD BASE STYLE (Glassmorphism Gelap) */
    .card {
        background: rgba(15, 15, 15, 0.75); 
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.08); 
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    /* 3. VARIASI WARNA KARTU */
    /* Variasi A: CYAN (Pemasukan) */
    .card-cyan { border-top: 4px solid #06b6d4; }
    .card-cyan:hover {
        box-shadow: 0 0 30px rgba(6, 182, 212, 0.15);
        border-color: rgba(6, 182, 212, 0.4);
        transform: translateY(-5px);
    }
    .text-cyan-neon { color: #22d3ee; text-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }

    /* Variasi B: RED/CRIMSON (Pengeluaran) */
    .card-red { border-top: 4px solid #f43f5e; }
    .card-red:hover {
        box-shadow: 0 0 30px rgba(244, 63, 94, 0.15);
        border-color: rgba(244, 63, 94, 0.4);
        transform: translateY(-5px);
    }
    .text-red-neon { color: #fb7185; text-shadow: 0 0 15px rgba(251, 113, 133, 0.4); }

    /* Variasi C: PURPLE (Arus Kas) */
    .card-purple { border-top: 4px solid #8b5cf6; }
    .card-purple:hover {
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.4);
        transform: translateY(-5px);
    }
    .text-purple-neon { color: #a78bfa; text-shadow: 0 0 15px rgba(167, 139, 250, 0.4); }

    /* Variasi D: GREEN (Laba) */
    .card-green { border-top: 4px solid #10b981; }
    .card-green:hover {
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.4);
        transform: translateY(-5px);
    }
    .text-green-neon { color: #34d399; text-shadow: 0 0 15px rgba(52, 211, 153, 0.4); }

    /* Variasi E: YELLOW/AMBER (Hutang/Piutang) */
    .card-yellow { border-top: 4px solid #f59e0b; }
    .card-yellow:hover {
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.15);
        border-color: rgba(245, 158, 11, 0.4);
        transform: translateY(-5px);
    }
    .text-yellow-neon { color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }


    /* Typography & Utilities */
    .kpi-label { font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.7; font-weight: 600; }
    .kpi-value { font-size: 2.5rem; font-weight: 800; }
    
    /* Efek Ambient Light di pojok kartu */
    .glow-blob {
        position: absolute;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        filter: blur(50px);
        opacity: 0.2;
        z-index: 0;
        top: -20px;
        right: -20px;
    }

</style>

<div id="app" class="flex flex-col items-center p-4 sm:p-8">
    
    <!-- HEADER: GRADASI HIJAU NEON & FOREST GREEN -->
    <header class="w-full max-w-6xl mb-12 z-10 relative">
        <!-- 
            Menerapkan bg-gradient-to-br from-[#114e2c] to-[#9bca1a] 
            Menambahkan shadow berwarna hijau agar menyatu
        -->
        <div class="rounded-3xl relative p-8 md:p-12 text-center border border-[#9bca1a]/30 bg-gradient-to-br from-[#114e2c] to-[#9bca1a] shadow-[0_20px_50px_rgba(17,78,44,0.5)]">
            
            <!-- Dekorasi Abstrak halus di dalam header -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full mix-blend-overlay filter blur-3xl translate-x-1/3 -translate-y-1/3"></div>
            <div class="absolute bottom-0 left-0 w-64 h-64 bg-black opacity-20 rounded-full mix-blend-multiply filter blur-3xl -translate-x-1/3 translate-y-1/3"></div>

            <div class="relative z-10">
                <div class="flex items-center justify-center space-x-4 mb-3">
                    <div class="h-px w-12 bg-white/40"></div>
                    <h2 class="text-xs font-bold tracking-[0.3em] uppercase text-green-100 drop-shadow-sm">
                        Financial Dashboard
                    </h2>
                    <div class="h-px w-12 bg-white/40"></div>
                </div>

                <h1 class="text-4xl md:text-6xl font-black mb-6 tracking-tight text-white drop-shadow-lg">
                    TOKO ALBAROKAH JAHE
                </h1>
                
                <!-- Info Box dengan latar gelap transparan agar kontras dengan hijau terang -->
                <div class="inline-flex flex-col items-center justify-center bg-black/20 backdrop-blur-md border border-white/20 rounded-2xl p-4 md:px-10 max-w-2xl mx-auto shadow-inner">
                    <p id="headerMonthYear" class="text-xl font-bold mb-1 text-white text-shadow-sm">
                        <!-- Diisi JS -->
                    </p>
                    <p id="headerDateRange" class="text-sm font-medium text-green-50">
                        <!-- Diisi JS -->
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- SECTION 1 (BARIS 1): KPI UTAMA -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl mb-12 relative z-10">
        
        <!-- 1. TOTAL PEMASUKAN (Warna: CYAN) -->
        <div class="card card-cyan p-6">
            <div class="glow-blob bg-cyan-500"></div>
            <div class="relative z-10">
                <p class="kpi-label text-cyan-200">1. TOTAL PEMASUKAN BERSIH</p>
                <span class="kpi-value text-cyan-neon" id="totalPemasukan">Rp 0</span>
                
                <div class="text-xs mt-4 space-y-2 text-gray-400 border-t border-cyan-500/20 pt-3">
                    <div class="flex justify-between">
                        <span>Omset Kotor:</span>
                        <span id="penjualanKotor" class="text-gray-200">Rp 0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Retur:</span>
                        <span id="totalRetur" class="text-red-400">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. TOTAL PENGELUARAN (Warna: RED/CRIMSON) -->
        <div class="card card-red p-6">
            <div class="glow-blob bg-rose-500"></div>
            <div class="relative z-10">
                <p class="kpi-label text-rose-200">2. TOTAL PENGELUARAN</p>
                <span class="kpi-value text-red-neon" id="totalPengeluaran">Rp 0</span>
                
                <div class="text-xs mt-4 space-y-2 text-gray-400 border-t border-rose-500/20 pt-3">
                    <div class="flex justify-between">
                        <span>Belanja Barang:</span>
                        <span id="belanjaBarang" class="text-gray-200">Rp 0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Ops Pokok:</span>
                        <span id="opsPokok" class="text-gray-200">Rp 0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Ops Lain-lain:</span>
                        <span id="opsLain" class="text-gray-200">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. ARUS KAS (Warna: PURPLE) -->
        <div class="card card-purple p-6">
            <div class="glow-blob bg-purple-500"></div>
            <div class="relative z-10">
                <p class="kpi-label text-purple-200">3. ARUS KAS (OPERASI)</p>
                <span class="kpi-value text-purple-neon" id="arusKasBersih">Rp 0</span>
                <div class="mt-4">
                    <p class="text-xs font-bold text-white bg-purple-500/20 py-1 px-3 rounded-md inline-block border border-purple-500/30" id="arusKasAnalisis"></p>
                </div>
            </div>
        </div>
        
    </section>
    
    <!-- SECTION 2 (BARIS 2): KPI 4 & 5 -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 w-full max-w-6xl mb-12 relative z-10">
        
        <!-- 4. LABA KOTOR (Warna: GREEN/EMERALD) -->
        <div class="card card-green p-6">
            <div class="glow-blob bg-emerald-500"></div>
            <div class="relative z-10">
                <p class="kpi-label text-emerald-200">4. LABA KOTOR BULAN INI</p>
                <div class="flex justify-between items-end mt-2">
                     <span class="kpi-value text-green-neon" id="labaKotorNominal">Rp 0</span>
                     <span class="text-lg font-bold text-emerald-300 bg-emerald-900/40 px-3 py-1 rounded border border-emerald-500/30" id="labaKotorProsentase">0%</span>
                </div>
                
                <div class="text-xs text-gray-300 mt-4 space-y-2 bg-emerald-900/10 p-3 rounded-lg border border-emerald-500/20">
                    <div class="flex justify-between">
                         <span>Operasional:</span>
                         <span id="operasionalKpi4" class="text-red-400">Rp 0</span>
                    </div>
                    <div class="flex justify-between font-bold pt-2 border-t border-emerald-500/20 text-white">
                         <span>Laba Bersih:</span>
                         <span id="labaBersihNominal" class="text-emerald-300">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. NETTO (Warna: YELLOW/AMBER) -->
        <div class="card card-yellow p-6">
            <div class="glow-blob bg-amber-500"></div>
            <div class="relative z-10">
                <p class="kpi-label text-amber-200">5. POSISI NETTO HUTANG/PIUTANG</p>
                <span class="kpi-value text-yellow-neon" id="posisiNetto">Rp 0</span>
                <div class="mt-4 p-3 rounded-lg bg-amber-900/10 border border-amber-500/20 text-sm">
                     <p class="text-amber-100 font-medium tracking-wide" id="hutangPiutangAnalisis">Piutang: Rp 0 | Hutang: Rp 0</p>
                </div>
            </div>
        </div>
        
    </section>

    <!-- SECTION 3: VISUALISASI UTAMA -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-6xl mb-8 relative z-10">
        
        <!-- STACKED BAR CHART -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-200 mb-4 border-b border-gray-800 pb-2">Komposisi Omset</h2>
            <div style="height: 350px; width: 100%;"> 
                <canvas id="omsetHppChart"></canvas>
            </div>
        </div>

        <!-- DOUGHNUT CHART -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-200 mb-4 border-b border-gray-800 pb-2">Rasio Beban Operasional Pokok</h2>
            <div style="height: 350px; width: 100%;"> 
                <canvas id="bebanChart"></canvas>
            </div>
        </div>
    </section>

    <!-- ANALISIS MARGIN -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-6xl mb-8 relative z-10">
        
        <!-- Tabel Margin BPOM/NON-BPOM -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-200 mb-4">Margin BPOM vs NON-BPOM</h2>
            <table class="w-full text-sm text-left border-collapse">
                <tbody id="marginAnalysisBodyBpNom"></tbody>
            </table>
        </div>
        
        <!-- Tabel Margin ONLINE vs OFFLINE -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-200 mb-4">Margin ONLINE vs OFFLINE</h2>
            <table class="w-full text-sm text-left border-collapse">
                <tbody id="marginAnalysisBodyOL"></tboady>
            </table>
        </div>
    </section>

    <!-- TABEL RINCIAN BEBAN -->
    <section class="w-full max-w-6xl card p-6 mb-8 relative z-10">
        <h2 class="text-lg font-bold text-gray-200 mb-3 border-b border-gray-800 pb-2">Rincian & Analisis Laba-Rugi</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Tabel Rincian Beban -->
            <div>
                <h3 class="font-bold text-md mb-3 text-red-400 uppercase tracking-widest text-xs">Rincian Beban</h3>
                <table class="w-full text-sm text-left text-gray-400 border-collapse">
                    <thead class="text-xs text-gray-500 uppercase bg-white/5">
                        <tr>
                            <th scope="col" class="px-3 py-2">Uraian</th>
                            <th scope="col" class="px-3 py-2 text-right">Jumlah</th>
                        </tr>
                    </thead>
                    <tbody id="bebanRincianBody"></tbody>
                </table>
            </div>
            <!-- Analisis Laba-Rugi -->
            <div>
                <h3 class="font-bold text-md mb-3 text-cyan-400 uppercase tracking-widest text-xs">Analisis Laba-Rugi</h3>
                <table class="w-full text-sm text-left text-gray-400 border-collapse">
                    <tbody id="labaAnalisisBody"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>
    // --- KONFIGURASI CHART.JS GLOBAL UNTUK TEMA GELAP ---
    Chart.defaults.color = '#94a3b8'; // Label abu-abu
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)'; // Grid lines sangat tipis
    
    // --- SCRIPT LOGIKA TANGGAL ---
    const today = new Date();
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const currentMonthName = months[today.getMonth()];
    const currentYear = today.getFullYear();
    const lastDayOfMonth = new Date(currentYear, today.getMonth() + 1, 0).getDate();

    document.getElementById('headerMonthYear').innerText = `Bulan ${currentMonthName} Tahun ${currentYear}`;
    document.getElementById('headerDateRange').innerText = `Mulai Tanggal 1 ${currentMonthName} ${currentYear} s.d. ${lastDayOfMonth} ${currentMonthName} ${currentYear} Selama ${lastDayOfMonth} hari`;

    // --- FUNGSI PENGOLAHAN DATA ---
    const params = new URLSearchParams(window.location.search);

    function getNumericValue(paramName, fallbackValue) {
        const urlValue = params.get(paramName);
        if (urlValue) {
            if (urlValue.includes(',')) {
                let parts = urlValue.split(',');
                let total = 0;
                parts.forEach(part => {
                    let cleanPart = String(part).replace(/[^0-9.-]/g, '');
                    total += Number(cleanPart) || 0;
                });
                return total;
            } else {
                let cleaned = String(urlValue).replace(/[^0-9.-]/g, ''); 
                return Number(cleaned);
            }
        }
        return fallbackValue;
    }
    
    function getBebanRincian() {
        const jsonString = params.get('beban_rincian');
        if (jsonString) {
            try { return JSON.parse(decodeURIComponent(jsonString)); } 
            catch (e) { console.error("Error parsing JSON:", e); return RAW_DATA.bebanRincian; }
        }
        return RAW_DATA.bebanRincian; 
    }

    const RAW_DATA = {
        totalPenjualanKotor: 0, totalRetur: 0, totalPemasukan: 0, 
        hppTotal: 0, opsNonPrive: 0, priveDiberikan: 0, 
        totalPengeluaran: 0, labaKotor: 0, totalBeban: 0, labaBersih: 0, 
        totalPiutang: 0, totalHutang: 0, 
        hppBpom: 0, labaBpom: 0, hppNonBpom: 0, labaNonBpom: 0,
        hppOffline: 0, labaOffline: 0, hppOnline: 0, labaOnline: 0, 
        omsetBpom: 0, omsetNonBpom: 0, omsetOffline: 0, omsetOnline: 0, 
        bebanRincian: []
    };

    const DATA = {
        totalPenjualanKotor: getNumericValue('penjualan_kotor', RAW_DATA.totalPenjualanKotor),
        totalRetur: getNumericValue('total_retur', RAW_DATA.totalRetur),
        totalPemasukan: getNumericValue('total_pemasukan', RAW_DATA.totalPemasukan),
        hppTotal: getNumericValue('hpp_total', RAW_DATA.hppTotal),
        labaKotor: getNumericValue('laba_kotor', RAW_DATA.labaKotor),
        labaBersih: getNumericValue('laba_bersih', RAW_DATA.labaBersih),
        priveDiberikan: getNumericValue('prive_diberikan', RAW_DATA.priveDiberikan),
        opsNonPrive: getNumericValue('ops_non_prive', RAW_DATA.opsNonPrive),
        totalPengeluaran: getNumericValue('total_pengeluaran', RAW_DATA.totalPengeluaran),
        arusKasBersih: getNumericValue('arus_kas_bersih', RAW_DATA.arusKasBersih),
        totalPiutang: getNumericValue('total_piutang', RAW_DATA.totalPiutang),
        totalHutang: getNumericValue('total_hutang', RAW_DATA.totalHutang),
        hppBpom: getNumericValue('hpp_bpom', RAW_DATA.hppBpom), 
        labaBpom: getNumericValue('laba_bpom', RAW_DATA.labaBpom),
        omsetBpom: getNumericValue('omset_bpom', RAW_DATA.omsetBpom),
        hppNonBpom: getNumericValue('hpp_non_bpom', RAW_DATA.hppNonBpom), 
        labaNonBpom: getNumericValue('laba_non_bpom', RAW_DATA.labaNonBpom),
        omsetNonBpom: getNumericValue('omset_non_bpom', RAW_DATA.omsetNonBpom),
        hppOffline: getNumericValue('hpp_offline', RAW_DATA.hppOffline), 
        labaOffline: getNumericValue('laba_offline', RAW_DATA.labaOffline),
        hppOnline: getNumericValue('hpp_online', RAW_DATA.hppOnline), 
        labaOnline: getNumericValue('laba_online', RAW_DATA.labaOnline),
        bebanRincian: getBebanRincian(),
    };

    function formatRupiah(angka) {
        if (!angka && angka !== 0) return '0';
        let num = Number(angka);
        if (isNaN(num)) return String(angka); 
        return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function formatAndColor(angka, isCost = false) {
        let num = Number(angka);
        if (isCost && num > 0) num = -num; 
        let formatted = 'Rp ' + formatRupiah(Math.abs(num));
        if (num < 0) {
            return `<span class="text-red-400 font-medium">(${formatted})</span>`;
        }
        return `<span>${formatted}</span>`;
    }

    function buildMarginRow(label, omset, hpp, color = 'indigo') {
        const margin = omset - hpp;
        const marginPercent = omset !== 0 ? (margin / omset) * 100 : 0;
        
        // Warna netral untuk tabel di bawah
        const bgClass = 'bg-white/5 text-gray-200';
        
        return `
            <tr class="${bgClass} font-bold border-none">
                <td class="px-3 py-2" colspan="2">${label}</td>
                <td class="px-3 py-2 text-right" colspan="2">${marginPercent.toFixed(2)}%</td>
            </tr>
            <tr>
                <td class="px-3 py-1 text-gray-500">Omset:</td>
                <td class="px-3 py-1 text-right text-gray-300" colspan="3">${formatAndColor(omset)}</td>
            </tr>
            <tr>
                <td class="px-3 py-1 text-gray-500">HPP:</td>
                <td class="px-3 py-1 text-right text-gray-300" colspan="3">${formatAndColor(hpp, true)}</td>
            </tr>
            <tr class="border-b border-gray-800">
                <td class="px-3 py-1 text-emerald-400 font-semibold" colspan="2">Margin Kotor:</td>
                <td class="px-3 py-1 text-right text-emerald-400 font-semibold" colspan="2">${formatAndColor(margin)}</td>
            </tr>
        `;
    }

    // A. SECTION 1 MAPPING
    document.getElementById('penjualanKotor').innerHTML = formatAndColor(DATA.totalPenjualanKotor);
    document.getElementById('totalRetur').innerHTML = formatAndColor(DATA.totalRetur); 
    document.getElementById('totalPemasukan').innerText = formatRupiah(DATA.totalPemasukan);

    // KPI 2
    const opsLainItem = Array.isArray(DATA.bebanRincian) ? DATA.bebanRincian.find(item => item.uraian && (item.uraian.toLowerCase().includes("lain"))) : null;
    const opsLainValue = opsLainItem ? opsLainItem.jumlah : 0;
    const opsPokokValue = DATA.opsNonPrive - opsLainValue;

    document.getElementById('belanjaBarang').innerHTML = formatAndColor(DATA.hppTotal, true);
    document.getElementById('opsPokok').innerHTML = formatAndColor(opsPokokValue, true);
    document.getElementById('opsLain').innerHTML = formatAndColor(opsLainValue, true);
    document.getElementById('totalPengeluaran').innerText = formatRupiah(DATA.totalPengeluaran);

    // KPI 3
    document.getElementById('arusKasBersih').innerText = formatRupiah(DATA.arusKasBersih);
    document.getElementById('arusKasAnalisis').innerText = DATA.arusKasBersih >= 0 ? 'Cash Flow Positif' : 'Cash Flow Negatif';

    // B. SECTION 2 MAPPING
    const labaKotor = DATA.labaKotor;
    const totalPemasukan = DATA.totalPemasukan;
    const marginProsentase = totalPemasukan !== 0 ? (labaKotor / totalPemasukan) * 100 : 0;
    const labaBersih = DATA.labaBersih;

    document.getElementById('labaKotorNominal').innerText = formatRupiah(labaKotor);
    document.getElementById('labaKotorProsentase').innerText = marginProsentase.toFixed(2) + '%';
    document.getElementById('operasionalKpi4').innerHTML = formatAndColor(DATA.opsNonPrive, true); 
    document.getElementById('labaBersihNominal').innerText = formatRupiah(labaBersih);
    
    const netto = DATA.totalPiutang - DATA.totalHutang;
    document.getElementById('posisiNetto').innerText = formatRupiah(netto);
    document.getElementById('hutangPiutangAnalisis').innerHTML = `Piutang: ${formatAndColor(DATA.totalPiutang)} | Hutang: ${formatAndColor(DATA.totalHutang, true)}`;

    
    // C. GRAFIK STACKED BAR CHART
    const barLabels = ['BPOM', 'NON-BPOM', 'OFFLINE', 'ONLINE'];
    const hppData = [DATA.hppBpom, DATA.hppNonBpom, DATA.hppOffline, DATA.hppOnline];
    const labaData = [DATA.labaBpom, DATA.labaNonBpom, DATA.labaOffline, DATA.labaOnline];
    
    const maxVal = Math.max(
        (DATA.hppBpom + DATA.labaBpom), 
        (DATA.hppNonBpom + DATA.labaNonBpom),
        (DATA.hppOffline + DATA.labaOffline)
    ) * 1.2 || 1000000;

    const ctxOmsetHpp = document.getElementById('omsetHppChart').getContext('2d');
    new Chart(ctxOmsetHpp, {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [
                {
                    label: 'HPP',
                    data: hppData,
                    backgroundColor: 'rgba(244, 63, 94, 0.7)', // Rose for HPP
                    hoverBackgroundColor: 'rgba(244, 63, 94, 1)',
                    stack: 'Stack 0', order: 1, 
                },
                {
                    label: 'Laba Kotor',
                    data: labaData,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)', // Emerald for Profit
                    hoverBackgroundColor: 'rgba(16, 185, 129, 1)',
                    stack: 'Stack 0', order: 2, 
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y', 
            scales: {
                x: { stacked: true, max: maxVal, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: {
                        callback: function(value) {
                            if (value >= 1000000000) return 'Rp ' + (value / 1000000000).toFixed(1) + ' M';
                            if (value >= 1000000) return 'Rp ' + (value / 1000000).toFixed(0) + ' Jt';
                            return value;
                        }
                    }
                },
                y: { stacked: true, grid: { display: false } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let index = context.dataIndex;
                            let totalOmsetKategori = hppData[index] + labaData[index];
                            let nilai = context.parsed.x; 
                            let result = label + ': ' + formatAndColor(nilai);
                            if (label === 'Laba Kotor') {
                                result += ` (${totalOmsetKategori !== 0 ? (labaData[index] / totalOmsetKategori * 100).toFixed(2) : 0}% Margin)`;
                            } else if (label === 'HPP') {
                                result += ` (${totalOmsetKategori !== 0 ? (hppData[index] / totalOmsetKategori * 100).toFixed(2) : 0}% HPP)`;
                            }
                            result += ' | Total Omset: ' + formatAndColor(totalOmsetKategori);
                            return result;
                        }
                    }
                }
            }
        }
    });

    // DOUGHNUT CHART (Rainbow Neon)
    const bebanRincianFinal = Array.isArray(DATA.bebanRincian) ? DATA.bebanRincian : [];
    const bebanLabels = bebanRincianFinal.map(b => b.uraian);
    const bebanData = bebanRincianFinal.map(b => b.jumlah);

    const ctxBeban = document.getElementById('bebanChart').getContext('2d');
    new Chart(ctxBeban, {
        type: 'doughnut',
        data: {
            labels: bebanLabels,
            datasets: [{
                data: bebanData,
                backgroundColor: ['#f43f5e', '#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#6366f1'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'right', labels: { color: '#cbd5e1' } }
            }
        }
    });

    const bebanBody = document.getElementById('bebanRincianBody');
    let totalBebanPokok = 0;
    
    if (bebanRincianFinal.length === 0) {
        bebanBody.innerHTML = `<tr><td colspan="2" class="px-3 py-2 text-center text-gray-500">Belum ada data rincian beban</td></tr>`;
    } else {
        bebanBody.innerHTML = ''; 
        bebanRincianFinal.forEach(item => {
            totalBebanPokok += item.jumlah;
            bebanBody.innerHTML += `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-3 py-2 text-gray-300">${item.uraian}</td>
                    <td class="px-3 py-2 text-right">${formatAndColor(item.jumlah, true)}</td>
                </tr>
            `;
        });
        bebanBody.innerHTML += `
            <tr class="bg-white/5 font-bold border-t border-white/10">
                <td class="px-3 py-2 text-gray-200">TOTAL BEBAN POKOK</td>
                <td class="px-3 py-2 text-right text-gray-200">${formatAndColor(totalBebanPokok, true)}</td>
            </tr>
        `;
    }

    const labaBody = document.getElementById('labaAnalisisBody');
    labaBody.innerHTML = `
        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
            <td class="px-3 py-2 text-gray-300">Total Pemasukan Bersih</td>
            <td class="px-3 py-2 text-right text-cyan-400">${formatAndColor(DATA.totalPemasukan)}</td>
        </tr>
        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
            <td class="px-3 py-2 text-gray-300">Total HPP</td>
            <td class="px-3 py-2 text-right text-red-400">${formatAndColor(DATA.hppTotal, true)}</td>
        </tr>
        <tr class="bg-white/5 font-bold border-b border-white/5">
            <td class="px-3 py-2 text-emerald-400">LABA KOTOR</td>
            <td class="px-3 py-2 text-right text-emerald-400">${formatAndColor(DATA.labaKotor)}</td>
        </tr>
        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
            <td class="px-3 py-2 text-gray-300">Total Beban Operasional</td>
            <td class="px-3 py-2 text-right text-red-400">${formatAndColor(DATA.opsNonPrive, true)}</td>
        </tr>
        <tr class="bg-gradient-to-r from-emerald-900/20 to-transparent font-bold border-t border-emerald-500/30">
            <td class="px-3 py-2 text-emerald-300">LABA BERSIH</td>
            <td class="px-3 py-2 text-right text-emerald-300">${formatAndColor(DATA.labaBersih)}</td>
        </tr>
    `;

    const marginBodyBpNom = document.getElementById('marginAnalysisBodyBpNom');
    const marginRata = totalPemasukan !== 0 ? (labaKotor / totalPemasukan) * 100 : 0;
    
    marginBodyBpNom.innerHTML = `
        <thead>
            <tr class="bg-white/10 text-gray-200">
                <th class="px-3 py-2" colspan="2">Kategori Produk</th>
                <th class="px-3 py-2 text-right" colspan="2">Margin %</th>
            </tr>
        </thead>
        ${buildMarginRow("NON-BPOM", DATA.omsetNonBpom, DATA.hppNonBpom, 'indigo')}
        ${buildMarginRow("BPOM", DATA.omsetBpom, DATA.hppBpom, 'indigo')}
        <tr class="bg-white/5 font-extrabold border-t border-white/20">
            <td class="px-3 py-2 text-gray-200" colspan="2">MARGIN RATA-RATA USAHA</td>
            <td class="px-3 py-2 text-right text-gray-200" colspan="2">${marginRata.toFixed(2)}%</td>
        </tr>
    `;
    
    const marginBodyOL = document.getElementById('marginAnalysisBodyOL');
    const omsetOfflineFinal = DATA.hppOffline + DATA.labaOffline;
    const omsetOnlineFinal = DATA.hppOnline + DATA.labaOnline;

    marginBodyOL.innerHTML = `
        <thead>
            <tr class="bg-white/10 text-gray-200">
                <th class="px-3 py-2" colspan="2">Kanal Penjualan</th>
                <th class="px-3 py-2 text-right" colspan="2">Margin %</th>
            </tr>
        </thead>
        ${buildMarginRow("OFFLINE", omsetOfflineFinal, DATA.hppOffline, 'green')}
        ${buildMarginRow("ONLINE", omsetOnlineFinal, DATA.hppOnline, 'green')}
        <tr class="bg-white/5 font-extrabold border-t border-white/20">
            <td class="px-3 py-2 text-gray-200" colspan="2">MARGIN RATA-RATA USAHA</td>
            <td class="px-3 py-2 text-right text-gray-200" colspan="2">${marginRata.toFixed(2)}%</td>
        </tr>
    `;

</script>
