<!--
RE-LAYOUT UI ONLY
- TIDAK mengubah ID penting
- MENAMBAHKAN JS MINIMAL agar UI tidak error
- Fokus struktur & tampilan
-->

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Generator Laporan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- fallback style (karena input-field & btn-add dipakai) -->
  <style>
    .input-field{background:#f9fafb;border:1px solid #d1d5db;border-radius:0.5rem;padding:0.5rem 0.75rem;width:100%}
    .money-input{text-align:right;font-weight:600}
    .btn-add{margin-top:0.5rem;width:100%;padding:0.5rem;border:2px dashed #d1d5db;border-radius:0.5rem;font-size:0.875rem;color:#6b7280}
    .btn-add:hover{border-color:#10b981;color:#10b981}
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ================= HEADER ================= -->
<header class="sticky top-0 z-40 bg-white border-b shadow-sm">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-black text-gray-800">Laporan Keuangan Bulanan</h1>
      <p class="text-xs text-gray-500">Admin Generator • isi → preview → generate</p>
    </div>
    <button onclick="generateLink?.()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2">
      <i class="fas fa-link"></i> Generate Link
    </button>
  </div>
</header>

<!-- ================= MAIN LAYOUT ================= -->
<main class="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

<!-- ================= LEFT : INPUT ================= -->
<section class="lg:col-span-2 space-y-6">

  <!-- BASE URL -->
  <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
    <h2 class="font-bold text-yellow-800 mb-2">Alamat Dashboard Tujuan</h2>
    <input type="text" id="baseUrl" class="input-field" placeholder="https://contoh.github.io/index.html" />
    <p class="text-xs text-yellow-700 mt-1">Link index.html tujuan (GitHub Pages / lokal)</p>
  </div>

  <!-- STEP 1 -->
  <div class="bg-white rounded-xl p-6 shadow border">
    <h2 class="font-bold text-gray-800 mb-4">STEP 1 — Identitas Laporan</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input id="bulanNama" class="input-field" placeholder="Nama Bulan" />
      <input id="tahunAngka" class="input-field" type="number" placeholder="Tahun" />
      <input id="startDate" class="input-field" placeholder="Tanggal Mulai" />
      <input id="endDate" class="input-field" placeholder="Tanggal Selesai" />
      <input id="durasi" class="input-field md:col-span-2" type="number" placeholder="Durasi Hari" />
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="bg-white rounded-xl p-6 shadow border">
    <h2 class="font-bold text-gray-800 mb-4">STEP 2 — Angka Inti</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="text-xs font-bold">Total Pemasukan</label>
        <input id="totalPemasukan" class="input-field money-input" />
      </div>
      <div>
        <label class="text-xs font-bold">Total Belanja</label>
        <input id="totalBelanja" class="input-field money-input" />
      </div>
      <div class="bg-gray-50 rounded-lg p-4 flex flex-col justify-center">
        <p class="text-xs text-gray-500">Laba Kotor</p>
        <p id="previewLabaKotor" class="text-2xl font-black">0</p>
      </div>
    </div>

    <details class="mt-4">
      <summary class="cursor-pointer text-xs text-gray-500">Detail tambahan</summary>
      <div class="grid grid-cols-2 gap-4 mt-2">
        <input id="penjualanKotor" class="input-field money-input" placeholder="Penjualan Kotor" />
        <input id="totalRetur" class="input-field money-input" placeholder="Total Retur" />
      </div>
    </details>
  </div>

  <!-- STEP 3 -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl p-6 shadow border">
      <h3 class="font-bold mb-2">Operasional Pokok</h3>
      <table class="w-full text-sm">
        <thead><tr class="text-left text-gray-400"><th>Uraian</th><th class="text-right">Jumlah</th><th></th></tr></thead>
        <tbody id="bodyPokok"></tbody>
      </table>
      <button onclick="addRow('bodyPokok')" class="btn-add">+ Tambah Baris</button>
    </div>

    <div class="bg-white rounded-xl p-6 shadow border">
      <h3 class="font-bold mb-2">Operasional Lain-lain</h3>
      <table class="w-full text-sm">
        <thead><tr class="text-left text-gray-400"><th>Uraian</th><th class="text-right">Jumlah</th><th></th></tr></thead>
        <tbody id="bodyLain"></tbody>
      </table>
      <button onclick="addRow('bodyLain')" class="btn-add">+ Tambah Baris</button>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="bg-white rounded-xl p-6 shadow border">
    <label class="flex items-center gap-2 text-sm cursor-pointer">
      <input type="checkbox" id="manualOverride" onchange="toggleManual()" />
      Aktifkan rincian margin lanjutan
    </label>

    <div id="advancedSection" class="hidden mt-4">
      <p class="text-xs text-gray-500 mb-3">Isi hanya jika ingin membagi margin BPOM / Online. Jika kosong, sistem akan mengisi otomatis.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="hppBpom" class="input-field money-input" placeholder="HPP BPOM" />
        <input id="labaBpom" class="input-field money-input" placeholder="Laba BPOM" />
        <input id="hppOnline" class="input-field money-input" placeholder="HPP Online" />
        <input id="labaOnline" class="input-field money-input" placeholder="Laba Online" />
      </div>
    </div>
  </div>

</section>

<!-- ================= RIGHT : PREVIEW ================= -->
<aside class="bg-gray-900 text-white rounded-xl p-6 shadow sticky top-24 h-fit">
  <h3 class="font-bold text-green-400 mb-4">Preview Ringkas</h3>
  <div class="space-y-3 text-sm">
    <div class="flex justify-between"><span>Laba Kotor</span><span id="previewLabaKotor">0</span></div>
    <div class="flex justify-between"><span>Total Operasional</span><span id="previewTotalOps">0</span></div>
    <div class="flex justify-between"><span>Total Pengeluaran</span><span id="previewTotalKeluar">0</span></div>
    <hr class="border-gray-700" />
    <div class="flex justify-between text-lg font-bold"><span>Laba Bersih</span><span id="previewLabaBersih">0</span></div>
  </div>
</aside>

</main>

<!-- ================= JS (UI + URL PARSER) ================= -->
<script>
  /* =========================
     1. TOGGLE UI (EXISTING)
     ========================= */
  function toggleManual(){
    const chk = document.getElementById('manualOverride');
    const sec = document.getElementById('advancedSection');
    if(!chk || !sec) return;
    chk.checked ? sec.classList.remove('hidden') : sec.classList.add('hidden');
  }

  /* =========================
     2. ADD ROW (EDITABLE)
     ========================= */
  function addRow(tbodyId, uraian = '', jumlah = ''){
    const tbody = document.getElementById(tbodyId);
    if(!tbody) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-1"><input type="text" class="input-field row-uraian" value="${uraian}" placeholder="Uraian" /></td>
      <td class="p-1"><input type="text" class="input-field money-input row-jumlah" value="${jumlah}" placeholder="0" /></td>
      <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-red-400">✕</button></td>
    `;
    tbody.appendChild(tr);
  }

  /* =========================
     3. URL PARAM PARSER
     ========================= */
  function getParam(name){
    return new URLSearchParams(window.location.search).get(name) || '';
  }

  function setVal(id, val){
    const el = document.getElementById(id);
    if(el && val !== null) el.value = val;
  }

  /* =========================
     4. INIT FROM URL
     ========================= */
  function initFromUrl(){
    if(!window.location.search) return;

    // basic fields
    setVal('bulanNama', getParam('bulan_nama'));
    setVal('tahunAngka', getParam('tahun_angka'));
    setVal('startDate', decodeURIComponent(getParam('start_date_text')));
    setVal('endDate', decodeURIComponent(getParam('end_date_text')));
    setVal('durasi', getParam('durasi_hari'));

    setVal('totalPemasukan', getParam('total_pemasukan'));
    setVal('totalBelanja', getParam('total_belanja'));
    setVal('penjualanKotor', getParam('penjualan_kotor'));
    setVal('totalRetur', getParam('total_retur'));

    // margin
    setVal('hppBpom', getParam('hpp_bpom'));
    setVal('labaBpom', getParam('laba_bpom'));
    setVal('hppOnline', getParam('hpp_online'));
    setVal('labaOnline', getParam('laba_online'));

    // auto open advanced if margin exists
    if(getParam('hpp_bpom') || getParam('hpp_online')){
      document.getElementById('manualOverride').checked = true;
      toggleManual();
    }

    // tabel: operasional lain
    try{
      const opsLain = JSON.parse(decodeURIComponent(getParam('rincian_ops_lain_v')));
      if(Array.isArray(opsLain)){
        opsLain.forEach(r => addRow('bodyLain', r.uraian, r.jumlah));
      }
    }catch(e){}

    // tabel: beban pokok
    try{
      const beban = JSON.parse(decodeURIComponent(getParam('beban_rincian')));
      if(Array.isArray(beban)){
        beban.forEach(r => addRow('bodyPokok', r.uraian, r.jumlah));
      }
    }catch(e){}
  }

  // INIT
  initFromUrl();
</script>

</body>
</html>
